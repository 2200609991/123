<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAIC 综合运营日报 (夸张虚拟版)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background-color: #f8fafc;
    }
    .tabs-trigger[data-state="active"] {
      background-color: white;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }
    .funnel-step {
        position: relative;
        color: white;
        padding: 0.75rem;
        margin: 0 auto;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .funnel-arrow {
        color: #4b5563;
        font-weight: 500;
        padding: 0.25rem 0;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-12">
      <h1 class="text-5xl font-bold text-slate-900">MAIC 综合运营日报</h1>
      <p class="text-xl text-slate-600 mt-3">统计日期：2025-07-25</p>
    </header>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-12">
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">注册用户数</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">新增用户</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">活跃用户</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">新用户激活率</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">次日留存率</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
      <div class="rounded-xl border bg-white p-6 transition-all duration-300 hover:bg-slate-50">
        <p class="text-lg font-semibold text-slate-800">用户反馈数</p>
        <p class="text-4xl font-bold text-slate-900 mt-2">...</p>
        <div class="flex items-center text-sm mt-2"><span class="flex items-center font-medium"></span><span class="text-slate-500 ml-1.5">较昨日</span></div>
      </div>
    </div>
    <main class="flex flex-col space-y-10">
      <div class="shadow-none border rounded-lg bg-white">
        <div class="p-6">
          <h2 class="flex items-center text-2xl font-bold text-slate-900">
            <i data-lucide="users" class="mr-3 h-7 w-7 text-indigo-600"></i>用户分析
          </h2>
        </div>
        <div class="p-6 pt-4">
          <div id="user-analysis-tabs" class="grid w-full grid-cols-2 md:grid-cols-4 mb-6 border p-1 rounded-lg bg-slate-50">
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="growth" data-state="active">近7日行为</button>
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="retention">留存热力图</button>
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="funnel">转化漏斗</button>
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="session">会话分布</button>
          </div>
          <div id="user-analysis-content">
            <div data-content="growth">
              <div class="h-96"><canvas id="userGrowthChart"></canvas></div>
            </div>
            <div data-content="retention" class="hidden">
              <table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">注册日</th><th class="px-6 py-3">次日</th><th class="px-6 py-3">3日</th><th class="px-6 py-3">7日</th></tr></thead><tbody id="retentionTableBody"></tbody></table>
            </div>
            <div data-content="funnel" class="hidden">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <select id="cohortInstFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
                <select id="cohortDateFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
                <input type="date" id="cutoffDateFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"/>
              </div>
              <div id="cohortSummary" class="text-center text-sm text-slate-600 p-2 bg-slate-100 rounded-md mb-4"></div>
              <div id="funnelDisplay" class="max-w-sm mx-auto space-y-0"></div>
            </div>
            <div data-content="session" class="hidden">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <select id="sessionInstFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
                <select id="sessionCourseFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
                <select id="sessionSegmentFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
              </div>
              <div id="sessionSummary" class="text-center text-sm text-slate-600 p-2 bg-slate-100 rounded-md mb-4"></div>
              <div class="h-80"><canvas id="sessionDistributionChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>
      <div class="shadow-none border rounded-lg bg-white">
        <div class="p-6">
          <h2 class="flex items-center text-2xl font-bold text-slate-900">
            <i data-lucide="book-open" class="mr-3 h-7 w-7 text-indigo-600"></i>内容分析
          </h2>
        </div>
        <div class="p-6 pt-4">
          <div id="content-analysis-tabs" class="mb-4 border p-1 rounded-lg bg-slate-50 inline-flex">
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="courses" data-state="active">课程板块</button>
            <button class="tabs-trigger py-2 px-4 text-sm font-medium text-slate-700 rounded-md" data-tab="institutions">机构板块</button>
          </div>
          <div id="content-analysis-content">
            <div data-content="courses">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">课程名称</th><th class="px-6 py-3">选课人数</th><th class="px-6 py-3">已完课用户</th><th class="px-6 py-3">活跃用户</th><th class="px-6 py-3">用户发言数</th><th class="px-6 py-3">平均学习(页)</th><th class="px-6 py-3">平均发言(次)</th></tr></thead><tbody id="courseTableBody"></tbody></table>
              </div>
            </div>
            <div data-content="institutions" class="hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">机构名称</th><th class="px-6 py-3">课程数</th><th class="px-6 py-3">累计注册</th><th class="px-6 py-3">新增用户</th><th class="px-6 py-3">上课用户</th><th class="px-6 py-3">周期内对话</th><th class="px-6 py-3">累计对话</th></tr></thead><tbody id="institutionTableBody"></tbody></table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="shadow-none border rounded-lg bg-white">
        <div class="p-6">
          <h2 class="flex items-center text-2xl font-bold text-slate-900">
            <i data-lucide="message-square" class="mr-3 h-7 w-7 text-indigo-600"></i>用户声音
          </h2>
        </div>
        <div id="feedback-list" class="p-6 pt-0 space-y-6"></div>
      </div>
      <div class="shadow-none border rounded-lg bg-white">
        <div class="p-6">
          <h2 class="flex items-center text-2xl font-bold text-slate-900">
            <i data-lucide="bar-chart-3" class="mr-3 h-7 w-7 text-indigo-600"></i>平台性能监控
          </h2>
        </div>
        <div class="p-6 pt-0">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <select id="perfInstFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
            <select id="perfCourseFilter" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm"></select>
          </div>
          <table class="w-full text-sm" id="perfTable"></table>
        </div>
      </div>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Random Data Generation ---

      // Helper Functions
      const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const getRandomFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
      const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      const getPastDateString = (format, offset) => {
        const date = new Date();
        date.setDate(date.getDate() - offset);
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        if (format === 'full') return `${y}-${m}-${d}`;
        return `${m}-${d}`;
      };
      const getRandomTimestamp = (offset) => {
        const date = new Date();
        date.setDate(date.getDate() - offset);
        date.setHours(getRandomInt(0, 23));
        date.setMinutes(getRandomInt(0, 59));
        date.setSeconds(getRandomInt(0, 59));
        return date.toISOString().replace('T', ' ').substring(0, 19);
      };
      const generateCumulativeArray = (total, length) => {
          let arr = Array.from({length}, () => getRandomInt(0, total));
          return arr.sort((a, b) => a - b);
      };
      const generateRandomString = (length) => {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        return Array.from({ length }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
      };
      
      // --- Fictional Content Definition ---
      const fictionalInstitutions = {
        "cyberspace_admin": "未来事务管理局",
        "st_warp_institute": "时空折跃研究所",
        "deepspace_univ": "深空探索大学",
        "singularity_coll": "奇点学院"
      };
      const fictionalCourses = {
        "quantum_entanglement": "量子纠缠入门",
        "martian_soil": "火星土壤分析",
        "ai_ethics": "AI伦理与未来社会",
        "memeology_intro": "迷因学概论",
        "vr_construction": "虚拟现实构建",
        "cat_philosophy": "猫咪哲学"
      };
      const fictionalFeedback = [
        "AI把我说的话当成歌词并进行了谱曲",
        "界面变成了赛博朋克风格，很酷但字看不清",
        "请求增加'一键乱码'功能",
        "视频里的猫好可爱，建议设为助教",
        "和AI辩论后，我开始怀疑自己是不是个程序",
        "为什么课程没有教我如何建造戴森球？",
        "系统推荐我学习《如何与植物沟通》，但我家没植物"
      ];
      
      const REPORT_DATE_OFFSET = 1; // Report for yesterday
      const REPORT_DATE_FULL = getPastDateString('full', REPORT_DATE_OFFSET);

      // --- Update Header and KPI Cards ---
      document.querySelector('header p.text-xl').textContent = `统计日期：${REPORT_DATE_FULL}`;

      function updateKpiCard(cardIndex, mainValue, changeValue, unit = '%', isAbsoluteChange = false) {
          const card = document.querySelector(`.grid > .rounded-xl:nth-child(${cardIndex})`);
          let formattedMainValue = Number.isInteger(mainValue) && mainValue > 999 ? formatNumber(mainValue) : mainValue;
          if (unit === '%' && !isAbsoluteChange) formattedMainValue += '%';
          card.querySelector('.text-4xl').textContent = formattedMainValue;
          const changeEl = card.querySelector('.flex.items-center span:first-child');
          const isPositive = changeValue >= 0;
          changeEl.className = `flex items-center font-medium ${isPositive ? 'text-emerald-600' : 'text-red-600'}`;
          let changeText = (isPositive ? '+' : '') + (isAbsoluteChange ? formatNumber(changeValue) : changeValue.toFixed(2) + unit);
          changeEl.innerHTML = `<i data-lucide="${isPositive ? 'trending-up' : 'arrow-down'}" class="h-4 w-4 mr-1"></i>${changeText}`;
      }
      
      updateKpiCard(1, 100000, getRandomInt(-999, 999), '', true);
      updateKpiCard(2, getRandomInt(50, 2000), getRandomInt(-500, 500), '', true);
      updateKpiCard(3, getRandomInt(20, 1000), getRandomInt(-200, 200), '', true);
      updateKpiCard(4, getRandomFloat(0.1, 25.0, 2), getRandomFloat(-5, 5, 2), '%');
      updateKpiCard(5, getRandomFloat(0.5, 30.0, 2), getRandomFloat(-10, 10, 2), '%');
      updateKpiCard(6, getRandomInt(0, 50), getRandomInt(-10, 10), '', true);

      // --- Mock Data Generation ---
      const userGrowthData = Array.from({ length: 7 }, (_, i) => ({
          date: getPastDateString('short', 6 - i + REPORT_DATE_OFFSET),
          '新增用户': getRandomInt(50, 2500),
          '上课用户': getRandomInt(10, 800)
      }));

      const retentionData = Array.from({ length: 10 }, (_, i) => {
          const offset = i + REPORT_DATE_OFFSET;
          const day1 = getRandomFloat(1.0, 40.0, 2);
          const day3 = (offset >= 3) ? getRandomFloat(day1 * 0.1, day1 * 0.7, 2) : null;
          const day7 = (offset >= 7) ? getRandomFloat(day3 * 0.2, day3 * 0.8, 2) : null;
          return { date: getPastDateString('full', offset), day1, day3, day7 };
      });

      const cohortFunnelMockData = {};
      const cohortInstitutions = Object.keys(fictionalInstitutions);
      cohortInstitutions.unshift('all'); // Add 'all' to the beginning
      const cohortDates = [getPastDateString('full', REPORT_DATE_OFFSET + 1), getPastDateString('full', REPORT_DATE_OFFSET + 2), getPastDateString('full', REPORT_DATE_OFFSET + 3)];
      cohortInstitutions.forEach(instKey => {
          cohortFunnelMockData[instKey] = {};
          cohortDates.forEach(date => {
              const factor = instKey === 'all' ? 1 : Math.random();
              const totalNewUsers = Math.round(getRandomInt(100, 5000) * factor);
              const maxLogin = Math.round(totalNewUsers * getRandomFloat(0.5, 0.95, 2));
              const maxClass = Math.round(maxLogin * getRandomFloat(0.05, 0.5, 2));
              const maxSpeak = Math.round(maxClass * getRandomFloat(0, 0.6, 2));
              cohortFunnelMockData[instKey][date] = { totalNewUsers, login: generateCumulativeArray(maxLogin, 7), class: generateCumulativeArray(maxClass, 7), speak: generateCumulativeArray(maxSpeak, 7) };
          });
      });

      const sessionMockData = [];
      Object.keys(fictionalInstitutions).forEach(inst => {
          Object.keys(fictionalCourses).forEach(course => {
              ['all_users', 'new_users', 'old_users'].forEach(segment => {
                  sessionMockData.push({ inst, course, segment, values: Array.from({ length: 6 }, (v, i) => getRandomInt(0, 5000 / (i * i + 1))) });
              });
          });
      });
      
      const courseData = Object.entries(fictionalCourses).map(([key, name]) => {
        const students = getRandomInt(10, 2000000);
        const completed = getRandomInt(0, students * 0.2);
        return { name, students, completed, active: getRandomInt(0, students * 0.1), posts: getRandomInt(0, students * 0.5), avgPages: getRandomFloat(1, 100, 1), avgPosts: getRandomFloat(0, 20, 1) }
      });
      
      const institutionData = Object.entries(fictionalInstitutions).map(([key, name]) => ({
        name, courses: getRandomInt(1, 50), totalReg: getRandomInt(100, 5000000), newUsers: getRandomInt(0, 5000), classUsers: getRandomInt(0, 2000), periodDialog: getRandomInt(0, 100000), totalDialog: getRandomInt(1000, 99999999)
      }));
      
      const feedbackData = Array.from({ length: getRandomInt(5, 10) }, () => ({
          text: fictionalFeedback[getRandomInt(0, fictionalFeedback.length - 1)],
          time: `${getRandomInt(0, 23).toString().padStart(2, '0')}:${getRandomInt(0, 59).toString().padStart(2, '0')}`,
          status: ["待处理", "处理中", "已解决", "无法复现"][getRandomInt(0,3)],
          username: `user_${generateRandomString(6)}`
      }));

      const perfMockData = {};
      const perfKeys = ['all-all'];
      Object.keys(fictionalInstitutions).forEach(inst => perfKeys.push(`${inst}-all`));
      perfKeys.forEach(key => {
          const meanFirst = getRandomFloat(0.5, 15.0, 2);
          const medianFirst = parseFloat((meanFirst - getRandomFloat(0.1, 2.0, 2)).toFixed(2));
          const p95First = parseFloat((meanFirst + getRandomFloat(5, 20, 2)).toFixed(2));
          perfMockData[key] = {
              "首响-均值(秒)": meanFirst, "首响-中位数(秒)": medianFirst, "首响-95分位数(秒)": p95First,
              "首响-9999分位数(秒)": parseFloat((p95First + getRandomFloat(10, 50, 2)).toFixed(2)), "首响-最大值(秒)": parseFloat((p95First + getRandomFloat(50, 200, 2)).toFixed(2)),
              "对话处理时长-均值(秒)": getRandomFloat(0.2, 30.0, 2), "对话处理时长-最大值(秒)": getRandomFloat(100, 5000, 2),
              "模型调用并发-中位数": getRandomInt(1, 10), "模型调用并发-95分位数": getRandomInt(5, 50), "模型调用并发-最大值": getRandomInt(10, 100), "模型调用并发-最大值时间": getRandomTimestamp(REPORT_DATE_OFFSET),
              "对话并发-中位数": getRandomInt(1, 20), "对话并发-95分位数": getRandomInt(10, 100), "对话并发-最大值": getRandomInt(20, 200), "对话并发-最大值时间": getRandomTimestamp(REPORT_DATE_OFFSET),
          };
      });
      const chartLabels = ["0轮", "1轮", "2-3轮", "4-5轮", "6-10轮", "10+轮"];

      // --- Tab Switching Logic ---
      function setupTabs(tabsContainerId, contentContainerId) {
        const tabsContainer = document.getElementById(tabsContainerId);
        const contentContainer = document.getElementById(contentContainerId);
        tabsContainer.addEventListener('click', (e) => {
          if (e.target.tagName !== 'BUTTON') return;
          tabsContainer.querySelector('[data-state="active"]').dataset.state = '';
          e.target.dataset.state = 'active';
          for (const child of contentContainer.children) {
            child.classList.add('hidden');
          }
          contentContainer.querySelector(`[data-content="${e.target.dataset.tab}"]`).classList.remove('hidden');
        });
      }
      setupTabs('user-analysis-tabs', 'user-analysis-content');
      setupTabs('content-analysis-tabs', 'content-analysis-content');
      
      // --- Render Charts & Tables with Randomized Data ---
      new Chart(document.getElementById('userGrowthChart'), { type: 'line', data: { labels: userGrowthData.map(d => d.date), datasets: [{ label: '新增用户', data: userGrowthData.map(d => d.新增用户), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }, { label: '上课用户', data: userGrowthData.map(d => d.上课用户), borderColor: '#d97706', backgroundColor: 'rgba(217, 119, 6, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false } });
      
      const retentionTableBody = document.getElementById('retentionTableBody');
      retentionData.forEach(row => {
        const tr = document.createElement('tr'); tr.className = 'bg-white border-b';
        tr.innerHTML = `<td class="px-6 py-4">${row.date}</td>` + ['day1', 'day3', 'day7'].map(d => {
            const val = row[d];
            return `<td class="px-6 py-4 ${val ? 'text-emerald-800 bg-emerald-50 font-medium' : ''}">${val ? `${val}%` : '-'}</td>`;
        }).join('');
        retentionTableBody.appendChild(tr);
      });

      const cohortInstFilter = document.getElementById('cohortInstFilter');
      const cohortDateFilter = document.getElementById('cohortDateFilter');
      const cutoffDateFilter = document.getElementById('cutoffDateFilter');
      const cohortSummary = document.getElementById('cohortSummary');
      const funnelDisplay = document.getElementById('funnelDisplay');
      function updateCohortFunnel() {
        const instKey = cohortInstFilter.value, cohortDateStr = cohortDateFilter.value, cutoffDateStr = cutoffDateFilter.value;
        const data = cohortFunnelMockData[instKey]?.[cohortDateStr];
        if (!data) { cohortSummary.textContent = "无可用数据"; funnelDisplay.innerHTML = ''; return; }
        const dayDiff = Math.max(0, Math.floor((new Date(cutoffDateStr) - new Date(cohortDateStr)) / (1000 * 60 * 60 * 24)));
        const totalUsers = data.totalNewUsers;
        const loginCount = data.login[Math.min(dayDiff, data.login.length - 1)];
        const classCount = data.class[Math.min(dayDiff, data.class.length - 1)];
        const speakCount = data.speak[Math.min(dayDiff, data.speak.length - 1)];
        cohortSummary.innerHTML = `分析 <b>${cohortDateStr}</b> 注册的 <b>${formatNumber(totalUsers)}</b> 人, 在 <b>${dayDiff + 1}</b> 日内的累计转化。`;
        const steps = [{ label: "注册", value: totalUsers, prev: totalUsers }, { label: "登录", value: loginCount, prev: totalUsers }, { label: "上课", value: classCount, prev: loginCount }, { label: "发言", value: speakCount, prev: classCount }];
        const colors = ["#4338ca", "#4f46e5", "#6366f1", "#818cf8"];
        funnelDisplay.innerHTML = '';
        steps.forEach((step, i) => {
            const stepConversion = i > 0 && step.prev > 0 ? ((step.value / step.prev) * 100).toFixed(1) : 0;
            const totalConversion = totalUsers > 0 ? ((step.value / totalUsers) * 100).toFixed(1) : 0;
            const clipPath = `polygon(${i * 8}% 0, ${100 - i * 8}% 0, ${100 - (i + 1) * 8}% 100%, ${(i + 1) * 8}% 100%)`;
            if (i > 0) funnelDisplay.innerHTML += `<div class="funnel-arrow text-center"><i data-lucide="arrow-down" class="w-4 h-4 mx-auto"></i><span class="text-sm font-medium">${stepConversion}%</span></div>`;
            funnelDisplay.innerHTML += `<div class="funnel-step" style="background-color: ${colors[i]}; clip-path: ${clipPath};"><div class="font-bold text-lg">${step.label}: ${formatNumber(step.value)} 人</div><div class="text-sm opacity-80">总转化率: ${totalConversion}%</div></div>`;
        });
        lucide.createIcons();
      }
      cohortInstFilter.innerHTML = `<option value="all">全部机构</option>` + Object.entries(fictionalInstitutions).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
      cohortDateFilter.innerHTML = cohortDates.map(d => `<option value="${d}">${d}</option>`).join('');
      cutoffDateFilter.value = getPastDateString('full', 0);
      [cohortInstFilter, cohortDateFilter, cutoffDateFilter].forEach(el => el.addEventListener('change', updateCohortFunnel));
      updateCohortFunnel();

      const sessionInstFilter = document.getElementById('sessionInstFilter');
      const sessionCourseFilter = document.getElementById('sessionCourseFilter');
      const sessionSegmentFilter = document.getElementById('sessionSegmentFilter');
      const sessionSummary = document.getElementById('sessionSummary');
      let sessionChart;
      function updateSessionChart() {
        let filtered = sessionMockData;
        if (sessionInstFilter.value !== "all") filtered = filtered.filter(d => d.inst === sessionInstFilter.value);
        if (sessionCourseFilter.value !== "all") filtered = filtered.filter(d => d.course === sessionCourseFilter.value);
        if (sessionSegmentFilter.value !== "all_users") filtered = filtered.filter(d => d.segment === sessionSegmentFilter.value);
        const result = new Array(chartLabels.length).fill(0);
        filtered.forEach(item => { for (let i = 0; i < result.length; i++) result[i] += item.values[i] || 0 });
        const totalUsers = result.reduce((a, b) => a + b, 0);
        sessionSummary.innerHTML = `总上课用户数: <span class="font-bold">${formatNumber(totalUsers)}</span> 人。(“0轮”指进入课程但未对话的用户)`;
        if (sessionChart) sessionChart.destroy();
        sessionChart = new Chart(document.getElementById('sessionDistributionChart'), { type: 'bar', data: { labels: chartLabels, datasets: [{ label: '用户数', data: result, backgroundColor: '#4f46e5' }] }, options: { responsive: true, maintainAspectRatio: false } });
      }
      sessionInstFilter.innerHTML = `<option value="all">全部机构</option>` + Object.entries(fictionalInstitutions).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
      sessionCourseFilter.innerHTML = `<option value="all">全部课程</option>` + Object.entries(fictionalCourses).map(([k, v]) => `<option value="${k}">${v}</option>`).join('');
      sessionSegmentFilter.innerHTML = `<option value="all_users">全部用户</option><option value="new_users">新用户</option><option value="old_users">老用户</option>`;
      [sessionInstFilter, sessionCourseFilter, sessionSegmentFilter].forEach(el => el.addEventListener('change', updateSessionChart));
      updateSessionChart();

      const courseTableBody = document.getElementById('courseTableBody');
      courseData.forEach(c => { const row = courseTableBody.insertRow(); row.className = 'bg-white border-b'; row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${c.name}</td><td class="px-6 py-4">${formatNumber(c.students)}</td><td class="px-6 py-4">${formatNumber(c.completed)}</td><td class="px-6 py-4">${formatNumber(c.active)}</td><td class="px-6 py-4">${formatNumber(c.posts)}</td><td class="px-6 py-4">${c.avgPages}</td><td class="px-6 py-4">${c.avgPosts}</td>`; });
      const institutionTableBody = document.getElementById('institutionTableBody');
      institutionData.forEach(i => { const row = institutionTableBody.insertRow(); row.className = 'bg-white border-b'; row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${i.name}</td><td class="px-6 py-4">${i.courses}</td><td class="px-6 py-4">${formatNumber(i.totalReg)}</td><td class="px-6 py-4">${formatNumber(i.newUsers)}</td><td class="px-6 py-4">${formatNumber(i.classUsers)}</td><td class="px-6 py-4">${formatNumber(i.periodDialog)}</td><td class="px-6 py-4">${formatNumber(i.totalDialog)}</td>`; });
      
      const feedbackList = document.getElementById('feedback-list');
      const statusColors = { "待处理": "#f87171", "处理中": "#fb923c", "已解决": "#4ade80", "无法复现": "#9ca3af" };
      const badgeColors = { "待处理": "bg-red-100 text-red-800", "处理中": "bg-orange-100 text-orange-800", "已解决": "bg-green-100 text-green-800", "无法复现": "bg-slate-100 text-slate-800" };
      feedbackData.forEach(item => { const div = document.createElement('div'); div.className = 'relative pl-6 border-l-4'; div.style.borderColor = statusColors[item.status]; div.innerHTML = `<p class="text-base font-medium text-slate-800">${item.text}</p><div class="flex justify-between items-center mt-2"><p class="text-sm text-slate-500">${item.username} · ${item.time}</p><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColors[item.status]}">${item.status}</span></div>`; feedbackList.appendChild(div); });
      
      const perfInstFilter = document.getElementById('perfInstFilter');
      const perfCourseFilter = document.getElementById('perfCourseFilter');
      const perfTable = document.getElementById('perfTable');
      function updatePerfTable() {
        const key = `${perfInstFilter.value}-${perfCourseFilter.value}`;
        const data = perfMockData[key] || perfMockData[`${perfInstFilter.value}-all`] || perfMockData['all-all'];
        let html = '<tbody>';
        const sections = { "首响": ["均值(秒)", "中位数(秒)", "95分位数(秒)", "9999分位数(秒)", "最大值(秒)"], "对话处理时长": ["均值(秒)", "最大值(秒)"], "模型调用并发": ["中位数", "95分位数", "最大值", "最大值时间"], "对话并发": ["中位数", "95分位数", "最大值", "最大值时间"] };
        for (const section in sections) {
          html += `<tr class="bg-slate-100 hover:bg-slate-100"><td colspan="2" class="p-3 font-semibold text-slate-800">${section}</td></tr>`;
          sections[section].forEach(metric => { const key = `${section}-${metric}`; html += `<tr><td class="pl-8 p-3 text-slate-600">${metric}</td><td class="p-3 font-semibold text-slate-900">${data[key] || '-'}</td></tr>`; });
        }
        perfTable.innerHTML = html + '</tbody>';
      }
      perfInstFilter.innerHTML = `<option value="all">全部机构</option>` + Object.entries(fictionalInstitutions).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
      perfCourseFilter.innerHTML = `<option value="all">全部课程</option>` + Object.entries(fictionalCourses).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
      [perfInstFilter, perfCourseFilter].forEach(el => el.addEventListener('change', updatePerfTable));
      updatePerfTable();

      // Finally, create all icons.
      lucide.createIcons();
    });
  </script>
</body>
</html>
